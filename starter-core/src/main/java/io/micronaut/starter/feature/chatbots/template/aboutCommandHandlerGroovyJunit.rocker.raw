@import io.micronaut.starter.application.Project
@args (Project project)
@if (project.getPackageName() != null) {
package @project.getPackageName()

}

import io.micronaut.chatbots.core.Dispatcher
import io.micronaut.chatbots.telegram.api.Update
import io.micronaut.chatbots.telegram.api.send.Send
import io.micronaut.chatbots.telegram.api.send.SendMessage
import io.micronaut.chatbots.telegram.core.TelegramBotConfiguration
import io.micronaut.context.BeanContext
import io.micronaut.json.JsonMapper
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Test

import static org.junit.jupiter.api.Assertions.assertEquals
import static org.junit.jupiter.api.Assertions.assertTrue

@@MicronautTest(startApplication = false)
class AboutCommandHandlerTest {

    @@Inject
    BeanContext ctx

    @@Inject
    Dispatcher<TelegramBotConfiguration, Update, Send> dispatcher

    @@Inject
    JsonMapper jsonMapper

    @@Test
    void beanOfTypeHelloWorldHandlerExists() {
        assertTrue(ctx.containsBean(AboutCommandHandler))
    }

    @@Test
    void aboutCommandHandlerExists() throws Exception {
        Send send = dispatcher.dispatch(null, jsonMapper.readValue(aboutCommandJson, Update.class)).get()

        assertTrue(send instanceof SendMessage)
        assertEquals("Telegram Bot developed with ðŸ’™ and [Micronaut](https://micronaut.io)", send.text.trim())
    }

    private String getAboutCommandJson() {
        """
          {
            "update_id": 952034417,
            "message": {
              "message_id": 447,
              "from": {
                "id": 613021175,
                "is_bot": false,
                "first_name": "John",
                "last_name": "Del Amo",
                "username": "johnsnow",
                "language_code": "en"
              },
              "chat": {
                "id": 613021175,
                "first_name": "John",
                "last_name": "Del Amo",
                "username": "johnsnow",
                "type": "private"
              },
              "date": 1662545408,
              "text": "/about",
              "entities": [
                {
                  "offset": 0,
                  "length": 6,
                  "type": "bot_command"
                }
              ]
            }
          }
        """
    }
}