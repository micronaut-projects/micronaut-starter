@import io.micronaut.starter.application.Project

@args (
Project project
)

@if (project.getPackageName() != null) {
package @project.getPackageName()

}

import com.agorapulse.worker.JobManager
import io.micronaut.test.extensions.spock.annotation.MicronautTest
import jakarta.inject.Inject

import spock.lang.Specification
import spock.util.concurrent.PollingConditions

@@MicronautTest
class EmailDigestSimpleJobSpec extends Specification {

    PollingConditions conditions = new PollingConditions()

    @@Inject EmailDigestSimpleJob job
    @@Inject JobManager jobManager

    void 'send email using simple job'() {
            expect:
                job.emailsSent == 0

            when:
                jobManager.forceRun(EmailDigestSimpleJob)

            then:
                conditions.eventually {
                    job.emailsSent == 1
                }
    }

}